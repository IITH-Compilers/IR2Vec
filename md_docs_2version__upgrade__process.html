<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>IR2Vec: version_upgrade_process</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">IR2Vec
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">version_upgrade_process</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The following guide details the steps followed in upgrading the LLVM version supported by IR2Vec</p>
<h1><a class="anchor" id="autotoc_md9"></a>
Compile the IR2Vec binary</h1>
<ul>
<li>Instructions for the same are present <a href="https://github.com/IITH-Compilers/IR2Vec/blob/main/README.md">here</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md10"></a>
Generating .ll files for re-training.</h1>
<ul>
<li>The git repo <code>IR2Vec-Version-Upgrade-Checks</code> has the required scripts to be run for this process.</li>
<li>The repo is available <a href="https://github.com/IITH-Compilers/IR2Vec-Version-Upgrade-Checks/">here</a></li>
<li>Our relevant scripts and files will be present in the folder <code>collect_ir</code>.<ul>
<li><code>collect_ir/spec/get_ll_files_list.py</code></li>
<li><code>collect_ir/boost/get_ll_files_list.py</code></li>
<li><code>collect_ir/spec/get_ll_spec.sh</code></li>
</ul>
</li>
<li>We use the C++ Library Boost, and the CPU-SPEC source codes to generate training data.<ul>
<li>Download these source codes.</li>
</ul>
</li>
<li>Compile the relevant Boost <code>.c*</code> files with the relevant LLVM version.<ul>
<li>The folder has the script <code>get_boost_ll.py</code> for this purpose.</li>
</ul>
</li>
<li>CPU/SPEC .c++ files compilation with the relevant LLVM version.<ul>
<li>For detailed instructions on this step, refer to <a href="https://github.com/IITH-Compilers/IR2Vec/wiki/spec_compilation">here</a>.</li>
</ul>
</li>
</ul>
<p>Collect the paths to all these compiled .ll / .o files in a single place using the scripts <code>collect_ir/spec/get_ll_files_list.py</code> and <code>collect_ir/boost/get_ll_files_list.py</code>.</p>
<ul>
<li>Once we have compiled the list of all the <code>.ll</code> file paths, we go to the seed_embedding folder in the main IR2Vec repository. Here, our process will have to involve the following tasks.<ul>
<li>Generating Training Triplets</li>
<li>Preprocessing the data</li>
<li>Training on the data and generating a final embedding file.</li>
<li>Using the embedding file to generate the test oracle.</li>
<li>Running the testing to verify the validity of the entire upgrade process.</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md11"></a>
Generating Training Triplets</h1>
<ul>
<li>Run the <code>triplets.sh</code> bash file with relevant changes to update the llvm version. Instructions to run the same are available at <code>seed_embeddings/README.md</code>.</li>
</ul>
<h1><a class="anchor" id="autotoc_md12"></a>
Preprocesing the data</h1>
<ul>
<li>In this same README.md file, we also have the instructions to run this next step.</li>
<li>The relevant file is present in the <code>openKE</code> folder, at <code>IR2Vec/seed_embeddings/OpenKE/preprocess.py</code></li>
<li>Once the file has been run, we should have a <code>preprocessed</code> folder. Inside this folder, we should have the relevant preprocessed data generated.</li>
<li>Go ahead and create an empty <code>embeddings</code> folder here. This will be relevant for the next step.</li>
</ul>
<p>We have recently retrained the IR2Vec embeddings with a larger dataset. This is the <a href="https://huggingface.co/datasets/llvm-ml/ComPile">ComPile</a> dataset. This dataset is a collection of LLVM IR files from open-source projects, and is considerably larger than the current dataset used in the original IR2Vec paper. Further details about the retraining process can be found <a href="https://github.com/IITH-Compilers/IR2Vec/wiki/comPile.md">here</a>.</p>
<p>Once the trainIDs, relations and entities files are generated, we can use them, as it is, in the training process as described before.</p>
<h1><a class="anchor" id="autotoc_md13"></a>
Training</h1>
<ul>
<li>The next file to run is the <code>generate_embeddings_ray.py</code> file in the <code>openKE</code> folder.<ul>
<li>Use the <code>openKE.yaml</code> file to create the conda environment.</li>
<li>This environment should have <code>Ray</code> and <code>tensorflow</code> installed.</li>
<li>Modify the <code>_ray.py</code> file with relevant training hyperparameters.</li>
<li>Run the file using the command <code>python3 generate_embeddings_ray.py</code>. This will run the training, generate the best embedding file and record the results.</li>
<li>Once we have generated the embeddings files, we have to use the embeddings file to update the <code>oracle</code> and get the <code>test_suite</code> working.</li>
<li>Copy the best embedding file into <code>seedEmbedding.txt</code> and move it to the <code>vocabulary</code> folder. Remove any prior files present there.</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md14"></a>
Generate Test Oracle</h1>
<ul>
<li>For this, we now move to the <code>src</code> folder. This folder contains the <code>test-suite</code> folder as well.</li>
<li>Here, two scripts are of importance. <code>generate_llfiles.sh</code> and <code>generateOracle.sh</code>. Run both of these files with the appropriate version of <code>llvm</code>.<ul>
<li>Modify <code>CMakeLists.txt</code> in the <code>test-suite</code> folder with the appropriate changes.</li>
<li>Similarly, modify the <code>sanity_check.sh.cmake</code> file with the appropriate paths for vocabulary, llvm version, etc.</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md15"></a>
Verification</h1>
<ul>
<li>Go to the <code>build</code> folder. Regenerate the contents using the CMAKE call from the build process</li>
<li>Run <code>make check</code>. This should compile successfully.</li>
</ul>
<h1><a class="anchor" id="autotoc_md16"></a>
Cosmetics</h1>
<ul>
<li>At this point, most of the code works as expected, however, for complete online testing and evaluation, we need to ensure that the appropriate llvm version is used throughout the code.</li>
<li>For this, running the command <code>git grep ..</code> helps.</li>
<li>For eg. Say, if we are changing from <code>llvm16</code> to <code>llvm17</code>, we can run the following commands to spot any required version changes in the code.<ul>
<li><code>git grep 16</code></li>
<li><code>git grep llvm16</code></li>
</ul>
</li>
<li>For the complete evaluation, we need to update the docker image as well.</li>
<li>The docker images for running the Github tests are available <a href="https://github.com/IITH-Compilers/manylinux2014-llvm/tree/main">here</a>.</li>
<li>The instructions to generate a new Docker image for the updated version are available <a href="https://github.com/IITH-Compilers/IR2Vec/wiki/docker_update">here</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md17"></a>
Pushing commits</h1>
<ul>
<li>Update <code>test.yml</code> in github workflows.</li>
<li>Install <code>pre-commit</code> in a fresh conda environment.</li>
<li>To test locally, run <code>pre-commit</code> install, followed by <code>pre-commit run --all-files</code>.</li>
</ul>
<p>Once all this is done, you should be able to push the commits without any test failures. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0
</small></address>
</div><!-- doc-content -->
</body>
</html>
